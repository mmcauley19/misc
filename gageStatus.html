<!DOCTYPE html>
<html>
 <head>
  <title>gageStatus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
   table#statusTable, td, th {
    border: 2px solid black;
    border-collapse:collapse;
    /*font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;*/
    font-family:"Helvetica Neue", Helvetica, Arial, sans-serif; 
   }
   table#statusTable thead {
    color:navy;
    /*border: 2px solid black; */
    display:table-header-group;
    background-color:#d5deeb;
   }
   table#statusTable thead th {
    text-align:left;
   }
   table#statusTable thead th.sortable {
    cursor: pointer;
   }
   /*table#statusTable thead th .sorthouse {
    font-weight:bold;
    color:lime;
   } */
   
   table#statusTable tbody .operational {
    background-color:#92F060;
   }
   table#statusTable tbody .questionable {
    background-color:#E6F060;
   }
   table#statusTable tbody .bad {
    background-color:#F06e60;
   }
  </style>
 </head>
 <body>
  <table id = "statusTable"></table></p>
  <script>
   var elmSorted = "";
   var sortType = "";
	 var json;
   function getSortOrderAsc(prop){
    return function(a,b){
     if (prop == "Status"){
      if (propToValue(a[prop]) > propToValue(b[prop]))
       return 1;
      else if (propToValue(a[prop]) < propToValue(b[prop]))
       return -1;
      return 0;
     }
     else{
      if (a[prop].toLowerCase() > b[prop].toLowerCase())
       return 1;
      else if (a[prop].toLowerCase() < b[prop].toLowerCase())
       return -1;
      return 0;
     }
    }
   }
   
   function getSortOrderDesc(prop){
    return function(a,b){
     if (prop == "Status"){
      if (propToValue(a[prop]) < propToValue(b[prop]))
       return 1;
      else if (propToValue(a[prop]) > propToValue(b[prop]))
       return -1;
      return 0;
     }
     else{
      if (a[prop].toLowerCase() < b[prop].toLowerCase())
       return 1;
      else if (a[prop].toLowerCase() > b[prop].toLowerCase())
       return -1;
      return 0;
     }
    }
   }

   //helper function for creating link
   function makeLink(url,cell,text){
    let link = document.createElement("a");
    link.href = url;
    link.textContent = text;
    link.target = "_blank";
    cell.appendChild(link);
    //let br = document.createElement("&nbsp");
    let space = document.createTextNode("  ");
    //cell.appendChild(br);
    cell.appendChild(space);
   }
   
 
//helper for sorting status, since alphabetical doesn't really make sense (questionable should be between bad and operational)
   function propToValue(gageStatus){
    if (gageStatus.toLowerCase() == "bad")
     return 3;
    else if (gageStatus.toLowerCase() == "questionable")
     return 2;
    else if (gageStatus.toLowerCase() == "operational")
     return 1;
    else
     return 0;
   }
   function setupSort(json,table,elm){
    if (elmSorted == elm){
     if (sortType == "asc")
      sortType = "desc";
     else
      sortType = "asc";
    }
    else
     sortType = "asc";

    elmSorted = elm;
    if (sortType == "asc")
     json.sort(getSortOrderAsc(elm));
    else
     json.sort(getSortOrderDesc(elm));
     
    let rows = table.querySelector("tbody tr");
    reviseTable(json,table);
   }

   function reviseTable(json,table){
    let tbody = table.querySelector("tbody");
    let rows = tbody.querySelectorAll("tr");
    for (let i=0;i<json.length;i++){
     rows[i].childNodes[0].textContent = json[i].Status;
     rows[i].childNodes[0].className = (json[i].Status).toLowerCase();
     rows[i].childNodes[1].textContent = json[i]["First Report"];
     rows[i].childNodes[2].textContent = json[i]["Location ID"];
     rows[i].childNodes[3].textContent = json[i].Name;
     rows[i].childNodes[4].textContent = json[i].WFO;
     rows[i].childNodes[5].querySelectorAll("A")[0].href = json[i].mesowestLink;
     rows[i].childNodes[5].querySelectorAll("A")[0].target = "_blank";
     //rows[i].childNodes[5].querySelectorAll("A")[0].textContent = json[i]["Location ID"]+"MW";
     rows[i].childNodes[5].querySelectorAll("A")[0].textContent = "MW";
     rows[i].childNodes[5].querySelectorAll("A")[1].href = json[i].nwsLink;
     rows[i].childNodes[5].querySelectorAll("A")[1].target = "_blank";
     //rows[i].childNodes[5].querySelectorAll("A")[1].textContent = json[i]["Location ID"]+"NWS";
     rows[i].childNodes[5].querySelectorAll("A")[1].textContent = "NWS";
     rows[i].childNodes[6].textContent = json[i].Notes;
     //rows[i].className = (json[i].Status).toLowerCase();
    }
   }

   function createTable(json,table){
    let header = document.createElement("thead");
    let row = document.createElement("tr");
    let cell = document.createElement("th");
    cell.classList.add("sortable");
    cell.textContent = "\u21C5  Status";
    cell.addEventListener("click",function(){
     setupSort(json,table,"Status");
    });
    row.appendChild(cell);
    cell = document.createElement("th");
    cell.classList.add("sortable");
    cell.textContent = "\u21C5  First Report";
    cell.addEventListener("click",function(){
     setupSort(json,table,"First Report");
    });
    row.appendChild(cell);
    cell = document.createElement("th");
    cell.classList.add("sortable");
    cell.textContent = "\u21C5  ID";
    cell.addEventListener("click",function(){
     setupSort(json,table,"Location ID");
    });
    row.appendChild(cell);
    cell = document.createElement("th");
    cell.classList.add("sortable");
    cell.textContent = "\u21C5  Name";
    cell.addEventListener("click",function(){
     setupSort(json,table,"Name");
    });
    row.appendChild(cell);
    cell = document.createElement("th");
    cell.classList.add("sortable");
    cell.textContent = "\u21C5  WFO";
    cell.addEventListener("click",function(){
     setupSort(json,table,"WFO");
    });
    row.appendChild(cell);
    cell = document.createElement("th");
    cell.textContent = "Link to Ob";
    row.appendChild(cell);
    cell = document.createElement("th");
    cell.textContent = "Notes";
    row.appendChild(cell);
    header.appendChild(row);
    table.appendChild(header);
    let tbody = document.createElement("tbody");
    table.appendChild(tbody);
    fillTable(json,table);
   }

   function fillTable(json,table){
    for (var i=0;i<json.length;i++){
     let tbody = table.querySelector("tbody");
	   let row = document.createElement("tr");
	   let cell = document.createElement("td");
	   let status = json[i].Status;
	   cell.textContent = status;
     cell.className = (status).toLowerCase();
	   row.appendChild(cell);
	   cell = document.createElement("td");
     cell.textContent = json[i]["First Report"];
     row.appendChild(cell);
	   cell = document.createElement("td");
     cell.textContent = json[i]["Location ID"];
	   row.appendChild(cell);
	   cell = document.createElement("td");
	   cell.textContent = json[i].Name;
	   row.appendChild(cell);
	   cell = document.createElement("td");
	   cell.textContent = json[i].WFO;
	   row.appendChild(cell);
	   cell = document.createElement("td");
     //makeLink(json[i].mesowestLink,cell,json[i]["Location ID"]+"MW");
     //makeLink(json[i].nwsLink,cell,json[i]["Location ID"]+"NWS");
     makeLink(json[i].mesowestLink,cell,"MW");
     makeLink(json[i].nwsLink,cell,"NWS");
	   row.appendChild(cell);
	   cell = document.createElement("td");
     cell.textContent = json[i].Notes;
     row.appendChild(cell);
   //  row.className = (status).toLowerCase();
	   tbody.appendChild(row);
    }
   }

   document.addEventListener("DOMContentLoaded",function(){
    var req = new XMLHttpRequest();
	req.open('GET',' https://script.googleusercontent.com/macros/echo?user_content_key=lFBDIwxHu8uMP2YIjZ4rTkph44sQ8hU4IcmgBjAi_OMomK6nCMOTQHEZmUHmDSM1ydQorX7QKvLuDS4Akb9Az-pdsEtHhsyGm5_BxDlH2jW0nuo2oDemN9CCS2h10ox_1xSncGQajx_ryfhECjZEnG-eZm-jLUSFG87Bnj5J5AjenQfNssDMPC4AmEKfQvHjFVxZhIMLmTS8mzDTCqnGIg&lib=MXTfKjftoipE0WwmBFaK8ZA0VGsytdp8v',true);
	req.addEventListener('load',function(){
	 console.log("it loaded");
	 if (req.status == 200){
	  json = JSON.parse(req.responseText);
	  let table = document.getElementById("statusTable");
    for (let i=0;i<json.length;i++){
     json[i]["nwsLink"] = "https://www.wrh.noaa.gov/mesowest/timeseries.php?sid="+json[i]["Location ID"]+"&num=168&banner=gmap&raw=0&w=325";
     json[i]["mesowestLink"] = "https://mesowest.utah.edu/cgi-bin/droman/meso_base_dyn.cgi?stn="+json[i]["Location ID"];
     json[i]["First Report"] = json[i]["First Report"].split("T")[0];
    }
    createTable(json,table);
	 }
	  
	});
	req.send();
  });
	</script>
 </body>
</html>
  
